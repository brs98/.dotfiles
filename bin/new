#!/bin/bash

# CLI script to create a new git worktree and wezterm workspace
# Usage: new <worktree-name> [--cwd <directory>]

set -e

WORKTREE_NAME=""
CWD="~/work/fluid-npm.git"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --cwd)
            CWD="$2"
            shift 2
            ;;
        *)
            if [ -z "$WORKTREE_NAME" ]; then
                WORKTREE_NAME="$1"
            else
                echo "Error: Unknown argument '$1'"
                exit 1
            fi
            shift
            ;;
    esac
done

if [ -z "$WORKTREE_NAME" ]; then
    echo "Usage: new <worktree-name> [--cwd <directory>]"
    echo "Example: new brandon/feature-1"
    echo "Example: new brandon/feature-1 --cwd ~/my-project"
    exit 1
fi

# Run the wezterm command that creates workspace, worktree, and runs setup commands
wezterm cli spawn --cwd "$CWD" --new-window --workspace "$WORKTREE_NAME" && 
PANE_ID=$(wezterm cli list --format json | jq -r '.[] | select(.workspace == "'$WORKTREE_NAME'") | .pane_id' | head -n1) && 
osascript -e 'tell application "WezTerm" to activate' && 
osascript -e 'tell application "System Events" to keystroke "s" using {command down, option down}' && 
osascript -e 'tell application "System Events" to keystroke "'$WORKTREE_NAME'"' && 
osascript -e 'tell application "System Events" to key code 36' && 
wezterm cli send-text --pane-id "$PANE_ID" "echo 'Creating worktree: $WORKTREE_NAME' && cd $CWD && git worktree add $WORKTREE_NAME && cd $WORKTREE_NAME"

echo "Created wezterm workspace '$WORKTREE_NAME' with git worktree"
